generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USERS (Admins/Operators)
// ============================================================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  role         UserRole @default(OPERATOR)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  activities POActivityLog[]

  @@map("users")
}

enum UserRole {
  ADMIN
  OPERATOR
}

// ============================================================================
// SUPPLIERS
// ============================================================================

model Supplier {
  id             String   @id @default(cuid())
  supplierNumber String   @unique
  name           String
  phone          String
  email          String?
  contactName    String?
  facility       String?
  notes          String?  // Manual annotations
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  purchaseOrders PurchaseOrder[]
  batches        SupplierBatch[]

  @@index([supplierNumber])
  @@map("suppliers")
}

// ============================================================================
// PURCHASE ORDERS
// ============================================================================

model PurchaseOrder {
  id         String  @id @default(cuid())
  externalId String? @unique // {PO#}-{Line}

  // Foreign keys
  supplierId String
  batchId    String?

  // Classification
  actionType POActionType
  status     POStatus     @default(PENDING)

  // PO Data
  poNumber         String
  poLine           Int
  partNumber       String
  partType         String?
  description      String?
  extraDescription String?

  // Quantities
  quantityOrdered  Decimal @db.Decimal(12, 2)
  quantityReceived Decimal @db.Decimal(12, 2)
  quantityBalance  Decimal @db.Decimal(12, 2)

  // Dates
  dueDate         DateTime
  originalDueDate DateTime?  // Stores original date before push out/expedite confirmation
  recommendedDate DateTime?
  poEntryDate     DateTime?

  // Pricing
  expectedUnitCost     Decimal @db.Decimal(12, 5)
  calculatedTotalValue Decimal @db.Decimal(12, 2)
  priceSourceCode      Int?

  // Metadata
  buyer            String?
  facility         String
  warehouseId      String?
  facilityItemType String?
  daysInTransit    Int?
  dispositionStatus String?
  poRevision       Int?

  // Raw data
  rawData Json?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  supplier Supplier       @relation(fields: [supplierId], references: [id])
  batch    SupplierBatch? @relation(fields: [batchId], references: [id])

  @@unique([poNumber, poLine])
  @@index([supplierId])
  @@index([batchId])
  @@index([status])
  @@index([actionType])
  @@map("purchase_orders")
}

enum POActionType {
  CANCEL
  EXPEDITE
  PUSH_OUT
}

enum POStatus {
  PENDING     // Received, not yet batched
  QUEUED      // In a batch, waiting for call
  IN_PROGRESS // Call in progress
  COMPLETED   // Successfully processed
  FAILED      // Failed after max retries
  CONFLICT    // Flagged for human review
}

// ============================================================================
// SUPPLIER BATCHES
// ============================================================================

model SupplierBatch {
  id         String @id @default(cuid())
  supplierId String

  // Status
  status BatchStatus @default(QUEUED)

  // Batch composition
  actionTypes String[] // ["CANCEL", "EXPEDITE", "PUSH_OUT"]
  totalValue  Decimal  @db.Decimal(12, 2)
  poCount     Int
  priority    Int      @default(0)

  // Retry tracking
  attemptCount Int       @default(0)
  maxAttempts  Int       @default(5)
  scheduledFor DateTime?

  // HappyRobot tracking
  happyRobotRunId String?

  // Outcome
  lastOutcome       String?
  lastOutcomeReason String?

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  // Relations
  supplier       Supplier        @relation(fields: [supplierId], references: [id])
  purchaseOrders PurchaseOrder[]
  agentRuns      POAgentRun[]
  logs           BatchLog[]

  @@index([supplierId])
  @@index([status])
  @@index([status, scheduledFor])
  @@map("supplier_batches")
}

enum BatchStatus {
  QUEUED      // In queue waiting
  IN_PROGRESS // Call active
  COMPLETED   // All POs resolved
  FAILED      // Max retries exhausted
  PARTIAL     // Some POs resolved, others need retry
}

// ============================================================================
// AGENT RUNS (Call attempts)
// ============================================================================

model POAgentRun {
  id      String @id @default(cuid())
  batchId String

  // HappyRobot tracking
  externalId  String? @unique // HappyRobot run_id
  externalUrl String?         // Link to HR platform

  // Status
  status PORunStatus @default(PENDING)

  // Outcome
  outcome       String?
  outcomeReason String?

  // Timing
  scheduledFor DateTime?
  startedAt    DateTime?
  endedAt      DateTime?
  duration     Int?      // seconds

  // Attempt tracking
  attempt Int @default(1)

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  batch SupplierBatch @relation(fields: [batchId], references: [id])

  @@index([batchId])
  @@index([externalId])
  @@index([status])
  @@map("po_agent_runs")
}

enum PORunStatus {
  PENDING
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
  CANCELLED
}

// ============================================================================
// BATCH LOGS (HappyRobot call logs)
// ============================================================================

model BatchLog {
  id        String   @id @default(cuid())
  batchId   String
  type      String   // "log", "po_update", "status_change"
  level     String   @default("info") // "info", "success", "warning", "error"
  message   String?
  data      Json?    // Additional structured data
  createdAt DateTime @default(now())

  // Relations
  batch SupplierBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([createdAt])
  @@map("batch_logs")
}

// ============================================================================
// CONFLICTS
// ============================================================================

model POConflict {
  id              String @id @default(cuid())
  purchaseOrderId String

  conflictType    String
  conflictDetails Json

  // Resolution
  resolvedAt      DateTime?
  resolvedBy      String?
  resolution      String?
  resolutionNotes String?

  createdAt DateTime @default(now())

  @@index([resolvedAt])
  @@map("po_conflicts")
}

// ============================================================================
// ACTIVITY LOG
// ============================================================================

model POActivityLog {
  id         String   @id @default(cuid())
  entityType String   // "PO", "BATCH", "SUPPLIER"
  entityId   String
  action     String
  details    Json?
  userId     String?
  createdAt  DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("po_activity_logs")
}

// ============================================================================
// SYSTEM CONFIG
// ============================================================================

model POSystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json
  description String?
  updatedAt   DateTime @updatedAt

  @@map("po_system_config")
}

// ============================================================================
// PASSWORD RESET TOKENS
// ============================================================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@map("password_reset_tokens")
}
